<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMM Price Impact - DeFi Visualized</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e4e4e4;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #00d9ff;
      margin-bottom: 8px;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .main-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      align-items: start;
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .formula {
      text-align: center;
      padding: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      color: #ff9f43;
      font-size: 18px;
    }
    .control-group {
      margin-bottom: 16px;
    }
    .control-group:last-child {
      margin-bottom: 0;
    }
    label {
      display: block;
      font-size: 14px;
      color: #aaa;
      margin-bottom: 8px;
    }
    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #333;
      outline: none;
      -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00d9ff;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
    }
    .value-display {
      font-size: 18px;
      font-weight: bold;
      color: #00d9ff;
    }
    .swap-input {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }
    .swap-input input {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #2a2a3e;
      color: #e4e4e4;
      font-size: 16px;
      outline: none;
    }
    .swap-input input:focus {
      border-color: #00d9ff;
    }
    .token-label {
      color: #888;
      font-size: 14px;
      min-width: 50px;
    }
    .swap-direction {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .swap-direction button {
      flex: 1;
      padding: 10px;
      border: 2px solid #444;
      border-radius: 8px;
      background: transparent;
      color: #888;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .swap-direction button.active {
      border-color: #00d9ff;
      color: #00d9ff;
      background: rgba(0, 217, 255, 0.1);
    }
    .stats {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(0, 217, 255, 0.1);
      border-radius: 8px;
    }
    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #00d9ff;
    }
    .stat-label {
      font-size: 13px;
      color: #888;
    }
    .stat.negative .stat-value {
      color: #ff6b6b;
    }
    .stat.positive .stat-value {
      color: #51cf66;
    }
    canvas {
      width: 100%;
      aspect-ratio: 1 / 1;
      max-height: 70vh;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
    }
    .chart-card {
      display: flex;
      flex-direction: column;
    }
    .legend {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      font-size: 13px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .pool-reserves {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .reserve {
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      text-align: center;
    }
    .reserve-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .reserve-value {
      font-size: 20px;
      font-weight: bold;
      color: #00d9ff;
    }
    .reserve-value.token-y {
      color: #ff9f43;
    }
    .reserve-input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #2a2a3e;
      color: #e4e4e4;
      font-size: 16px;
      text-align: center;
      outline: none;
    }
    .reserve-input:focus {
      border-color: #00d9ff;
    }
    .token-input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #2a2a3e;
      color: #e4e4e4;
      font-size: 14px;
      text-align: center;
      outline: none;
    }
    .token-input:focus {
      border-color: #00d9ff;
    }
    .disclaimer-title {
      font-size: 14px;
      font-weight: 600;
      color: #cfcfcf;
      margin-bottom: 10px;
    }
    .disclaimer p,
    .disclaimer li {
      color: #b0b0b0;
      font-size: 13px;
      line-height: 1.5;
    }
    .disclaimer ul {
      margin: 8px 0 0 18px;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AMM Price Impact</h1>
    <p class="subtitle">See how the constant product formula affects swap prices</p>

    <div class="main-layout">
      <div class="sidebar">
        <div class="card">
          <div class="formula">x × y = k</div>
        </div>

        <div class="card">
          <div class="pool-reserves">
            <div class="reserve">
              <input class="token-input" type="text" id="tokenXName" value="Token X" maxlength="12">
              <input class="reserve-input" type="number" id="reserveXInput" value="1000" min="1" step="1">
            </div>
            <div class="reserve">
              <input class="token-input" type="text" id="tokenYName" value="Token Y" maxlength="12">
              <input class="reserve-input" type="number" id="reserveYInput" value="1000" min="1" step="1">
            </div>
          </div>

          <div class="control-group">
            <label>Pool Liquidity (k = x × y)</label>
            <div style="margin-top: 4px; color: #666; font-size: 13px;">k = <span id="kValue">1,000,000</span></div>
          </div>
        </div>

        <div class="card">
          <div class="swap-direction">
            <button id="swapXY" class="active" onclick="setDirection('xy')">Swap X → Y</button>
            <button id="swapYX" onclick="setDirection('yx')">Swap Y → X</button>
          </div>

          <div class="control-group">
            <label>Swap Amount</label>
            <div class="swap-input">
              <input type="number" id="swapAmount" value="100" min="1" max="5000">
              <span class="token-label" id="inputToken">Token X</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="stats">
            <div class="stat">
              <div class="stat-label">You Send</div>
              <div class="stat-value" id="sendAmount">100 X</div>
            </div>
            <div class="stat">
              <div class="stat-label">You Receive</div>
              <div class="stat-value" id="receiveAmount">— Y</div>
            </div>
            <div class="stat">
              <div class="stat-label">Spot Price (before)</div>
              <div class="stat-value" id="spotPrice">1.00</div>
            </div>
            <div class="stat">
              <div class="stat-label">Execution Price</div>
              <div class="stat-value" id="execPrice">—</div>
            </div>
            <div class="stat negative" id="impactStat">
              <div class="stat-label">Price Impact</div>
              <div class="stat-value" id="priceImpact">—</div>
            </div>
          </div>
        </div>

      </div>

      <div class="card chart-card">
        <canvas id="chart"></canvas>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-dot" style="background: #00d9ff;"></div>
            <span>Constant Product Curve</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #51cf66;"></div>
            <span>Current Position</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #ff6b6b;"></div>
            <span>After Swap</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card disclaimer" style="margin-top: 20px;">
      <div class="disclaimer-title">ℹ️ Simplifications</div>
      <p style="margin: 0 0 10px 0;">This is an educational visualization, not a technical specification. Some details are simplified:</p>
      <ul>
        <li><strong>No Fees:</strong> Real AMMs charge swap fees, which worsen execution price.</li>
        <li><strong>Manual Reserves:</strong> You set pool reserves directly; this doesn’t simulate deposits/withdrawals or market-driven rebalancing.</li>
        <li><strong>Single-Swap View:</strong> The pool doesn’t persist state after a swap, so consecutive swaps are not modeled.</li>
        <li><strong>External Markets:</strong> Ignores outside prices, arbitrage, and liquidity provider behavior.</li>
      </ul>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');

    let k = 1000000;
    let reserveX = 1000;
    let reserveY = 1000;
    let swapDirection = 'xy'; // 'xy' means swap X for Y
    let swapAmount = 100;

    const swapAmountInput = document.getElementById('swapAmount');
    const reserveXInput = document.getElementById('reserveXInput');
    const reserveYInput = document.getElementById('reserveYInput');
    const tokenXNameInput = document.getElementById('tokenXName');
    const tokenYNameInput = document.getElementById('tokenYName');

    function setupCanvas() {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
    }

    function setDirection(dir) {
      swapDirection = dir;
      document.getElementById('swapXY').classList.toggle('active', dir === 'xy');
      document.getElementById('swapYX').classList.toggle('active', dir === 'yx');
      document.getElementById('inputToken').textContent = dir === 'xy' ? 'Token X' : 'Token Y';
      draw();
    }

    function calculateSwap(amountIn, reserveIn, reserveOut) {
      // Constant product: (reserveIn + amountIn) * (reserveOut - amountOut) = k
      // amountOut = reserveOut - k / (reserveIn + amountIn)
      const newReserveIn = reserveIn + amountIn;
      const newReserveOut = k / newReserveIn;
      const amountOut = reserveOut - newReserveOut;
      return {
        amountOut,
        newReserveIn,
        newReserveOut
      };
    }

    function formatNumber(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(2) + 'K';
      return n.toFixed(2);
    }

    function draw() {
      setupCanvas();
      const rect = canvas.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      const padding = 50;

      // Update reserves from inputs
      reserveX = parseFloat(reserveXInput.value) || 0;
      reserveY = parseFloat(reserveYInput.value) || 0;
      if (reserveX <= 0 || reserveY <= 0) {
        reserveX = 1000;
        reserveY = 1000;
        reserveXInput.value = reserveX;
        reserveYInput.value = reserveY;
      }
      k = reserveX * reserveY;

      // Clear
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fillRect(0, 0, width, height);

      // Calculate swap
      const inputAmount = parseFloat(swapAmountInput.value) || 0;
      let swap, newX, newY, spotPrice, execPrice;

      if (swapDirection === 'xy') {
        swap = calculateSwap(inputAmount, reserveX, reserveY);
        newX = swap.newReserveIn;
        newY = swap.newReserveOut;
        spotPrice = reserveY / reserveX;
        execPrice = inputAmount > 0 ? swap.amountOut / inputAmount : spotPrice;
      } else {
        swap = calculateSwap(inputAmount, reserveY, reserveX);
        newY = swap.newReserveIn;
        newX = swap.newReserveOut;
        spotPrice = reserveX / reserveY;
        execPrice = inputAmount > 0 ? swap.amountOut / inputAmount : spotPrice;
      }

      // Axis scale
      const maxAxis = Math.max(reserveX, reserveY, newX || 0, newY || 0) * 1.8;

      // Draw grid
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (height - 2 * padding) * (1 - i / 5);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();

        const x = padding + (width - 2 * padding) * i / 5;
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, height - padding);
        ctx.stroke();
      }

      // Draw curve x * y = k
      ctx.beginPath();
      ctx.strokeStyle = '#00d9ff';
      ctx.lineWidth = 3;
      let started = false;
      for (let px = 1; px <= maxAxis; px += maxAxis / 500) {
        const py = k / px;
        if (py > maxAxis) continue;

        const screenX = padding + (width - 2 * padding) * (px / maxAxis);
        const screenY = height - padding - (height - 2 * padding) * (py / maxAxis);

        if (!started) {
          ctx.moveTo(screenX, screenY);
          started = true;
        } else {
          ctx.lineTo(screenX, screenY);
        }
      }
      ctx.stroke();

      // Draw current position
      const currentScreenX = padding + (width - 2 * padding) * (reserveX / maxAxis);
      const currentScreenY = height - padding - (height - 2 * padding) * (reserveY / maxAxis);

      ctx.beginPath();
      ctx.arc(currentScreenX, currentScreenY, 12, 0, Math.PI * 2);
      ctx.fillStyle = '#51cf66';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Draw new position after swap
      if (inputAmount > 0 && newX && newY && newX > 0 && newY > 0) {
        const newScreenX = padding + (width - 2 * padding) * (newX / maxAxis);
        const newScreenY = height - padding - (height - 2 * padding) * (newY / maxAxis);

        // Draw arrow from current to new
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(255, 107, 107, 0.5)';
        ctx.lineWidth = 3;
        ctx.setLineDash([8, 8]);
        ctx.moveTo(currentScreenX, currentScreenY);
        ctx.lineTo(newScreenX, newScreenY);
        ctx.stroke();
        ctx.setLineDash([]);

        // Draw new position dot
        ctx.beginPath();
        ctx.arc(newScreenX, newScreenY, 12, 0, Math.PI * 2);
        ctx.fillStyle = '#ff6b6b';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      // Axis labels
      ctx.fillStyle = '#666';
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'center';
      for (let i = 0; i <= 5; i++) {
        const val = (maxAxis * i / 5);
        const x = padding + (width - 2 * padding) * i / 5;
        ctx.fillText(formatNumber(val), x, height - padding + 20);

        const y = height - padding - (height - 2 * padding) * i / 5;
        ctx.textAlign = 'right';
        ctx.fillText(formatNumber(val), padding - 10, y + 4);
        ctx.textAlign = 'center';
      }

      // Axis titles
      ctx.fillStyle = '#888';
      ctx.font = '14px sans-serif';
      ctx.fillText('Token X Reserve', width / 2, height - 10);
      ctx.save();
      ctx.translate(15, height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('Token Y Reserve', 0, 0);
      ctx.restore();

      // Update UI
      document.getElementById('kValue').textContent = k.toLocaleString();

      const tokenXName = tokenXNameInput.value.trim() || 'Token X';
      const tokenYName = tokenYNameInput.value.trim() || 'Token Y';
      const inToken = swapDirection === 'xy' ? tokenXName : tokenYName;
      const outToken = swapDirection === 'xy' ? tokenYName : tokenXName;

      document.getElementById('inputToken').textContent = inToken;
      document.getElementById('sendAmount').textContent = `${formatNumber(inputAmount)} ${inToken}`;
      document.getElementById('receiveAmount').textContent = inputAmount > 0 ? `${formatNumber(swap.amountOut)} ${outToken}` : `— ${outToken}`;
      document.getElementById('spotPrice').textContent = `1 ${inToken} = ${spotPrice.toFixed(4)} ${outToken}`;
      document.getElementById('execPrice').textContent = inputAmount > 0 ? `1 ${inToken} = ${execPrice.toFixed(4)} ${outToken}` : '—';

      const priceImpact = inputAmount > 0 ? ((spotPrice - execPrice) / spotPrice) * 100 : 0;
      const impactEl = document.getElementById('priceImpact');
      const impactStat = document.getElementById('impactStat');
      impactEl.textContent = inputAmount > 0 ? `-${priceImpact.toFixed(2)}%` : '—';
      impactStat.classList.toggle('negative', priceImpact > 1);
    }

    // Event listeners
    swapAmountInput.addEventListener('input', draw);
    reserveXInput.addEventListener('input', draw);
    reserveYInput.addEventListener('input', draw);
    tokenXNameInput.addEventListener('input', draw);
    tokenYNameInput.addEventListener('input', draw);

    window.addEventListener('resize', draw);

    // Initial draw
    draw();
  </script>
</body>
</html>
