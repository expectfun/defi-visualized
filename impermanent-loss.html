<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Impermanent Loss - DeFi Visualized</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e4e4e4;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #00d9ff;
      margin-bottom: 8px;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .main-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      align-items: start;
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .formula {
      text-align: center;
      padding: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      color: #ff9f43;
      font-size: 14px;
      line-height: 1.6;
    }
    .control-group {
      margin-bottom: 20px;
    }
    .control-group:last-child {
      margin-bottom: 0;
    }
    label {
      display: block;
      font-size: 14px;
      color: #aaa;
      margin-bottom: 8px;
    }
    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #333;
      outline: none;
      -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00d9ff;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
    }
    .value-display {
      font-size: 18px;
      font-weight: bold;
      color: #00d9ff;
    }
    .price-display {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 13px;
      color: #666;
    }
    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .comparison-box {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    .comparison-box.hodl {
      background: rgba(0, 217, 255, 0.15);
      border: 1px solid rgba(0, 217, 255, 0.3);
    }
    .comparison-box.lp {
      background: rgba(255, 159, 67, 0.15);
      border: 1px solid rgba(255, 159, 67, 0.3);
    }
    .comparison-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
    }
    .comparison-value {
      font-size: 24px;
      font-weight: bold;
    }
    .comparison-box.hodl .comparison-value {
      color: #00d9ff;
    }
    .comparison-box.lp .comparison-value {
      color: #ff9f43;
    }
    .comparison-detail {
      font-size: 11px;
      color: #666;
      margin-top: 6px;
    }
    .il-result {
      text-align: center;
      padding: 20px;
      background: rgba(255, 107, 107, 0.15);
      border-radius: 12px;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }
    .il-label {
      font-size: 14px;
      color: #888;
      margin-bottom: 8px;
    }
    .il-value {
      font-size: 32px;
      font-weight: bold;
      color: #ff6b6b;
    }
    .il-value.zero {
      color: #51cf66;
    }
    .il-note {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
    canvas {
      width: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
    }
    .chart-card {
      display: flex;
      flex-direction: column;
    }
    .legend {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      font-size: 13px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-line {
      width: 24px;
      height: 3px;
      border-radius: 2px;
    }
    .initial-position {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .initial-token {
      text-align: center;
    }
    .initial-token-label {
      font-size: 11px;
      color: #666;
    }
    .initial-token-value {
      font-size: 16px;
      font-weight: bold;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Impermanent Loss</h1>
    <p class="subtitle">See how price changes affect liquidity providers</p>

    <div class="main-layout">
      <div class="sidebar">
        <div class="card">
          <div class="formula">
            IL = 2√r / (1 + r) − 1<br>
            <span style="color: #666;">where r = price ratio</span>
          </div>
        </div>

        <div class="card">
          <div class="initial-position">
            <div class="initial-token">
              <div class="initial-token-label">Initial ETH</div>
              <div class="initial-token-value">1 ETH</div>
            </div>
            <div class="initial-token">
              <div class="initial-token-label">Initial USD</div>
              <div class="initial-token-value" id="initialUsd">$1,000</div>
            </div>
          </div>

          <div class="control-group">
            <label>Initial ETH Price: <span class="value-display">$<span id="initialPriceDisplay">1,000</span></span></label>
            <input type="range" id="initialPrice" min="100" max="5000" value="1000" step="100">
          </div>

          <div class="control-group">
            <label>Current ETH Price: <span class="value-display">$<span id="currentPriceDisplay">1,000</span></span></label>
            <input type="range" id="currentPrice" min="100" max="5000" value="1000" step="10">
            <div class="price-display">
              <span>$100</span>
              <span id="priceChange">0% change</span>
              <span>$5,000</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="comparison">
            <div class="comparison-box hodl">
              <div class="comparison-label">If You Just Held</div>
              <div class="comparison-value" id="hodlValue">$2,000</div>
              <div class="comparison-detail" id="hodlDetail">1 ETH + $1,000</div>
            </div>
            <div class="comparison-box lp">
              <div class="comparison-label">LP Position Value</div>
              <div class="comparison-value" id="lpValue">$2,000</div>
              <div class="comparison-detail" id="lpDetail">1 ETH + $1,000</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="il-result">
            <div class="il-label">Impermanent Loss</div>
            <div class="il-value" id="ilValue">0.00%</div>
            <div class="il-note" id="ilNote">No loss when price unchanged</div>
          </div>
        </div>
      </div>

      <div class="card chart-card">
        <canvas id="chart"></canvas>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-line" style="background: #00d9ff;"></div>
            <span>HODL Value</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #ff9f43;"></div>
            <span>LP Value</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #ff6b6b;"></div>
            <span>Impermanent Loss</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #51cf66; height: 2px; border-style: dashed;"></div>
            <span>Current Price</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');

    const initialPriceSlider = document.getElementById('initialPrice');
    const currentPriceSlider = document.getElementById('currentPrice');

    function setupCanvas() {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
    }

    function calculateIL(priceRatio) {
      // IL = 2 * sqrt(r) / (1 + r) - 1
      return 2 * Math.sqrt(priceRatio) / (1 + priceRatio) - 1;
    }

    function calculateLPValue(initialEth, initialUsd, initialPrice, currentPrice) {
      // In an AMM, LP maintains constant product
      // Initial: eth * usd = k, where usd = eth * price
      // So: eth * (eth * price) = k => eth² * price = k
      // At new price: newEth² * newPrice = k
      // newEth = sqrt(k / newPrice)

      const k = initialEth * initialUsd; // constant product
      const newEth = Math.sqrt(k / currentPrice);
      const newUsd = Math.sqrt(k * currentPrice);

      return {
        eth: newEth,
        usd: newUsd,
        total: newEth * currentPrice + newUsd
      };
    }

    function calculateHodlValue(initialEth, initialUsd, currentPrice) {
      return {
        eth: initialEth,
        usd: initialUsd,
        total: initialEth * currentPrice + initialUsd
      };
    }

    function formatCurrency(n) {
      if (n >= 10000) return '$' + (n / 1000).toFixed(1) + 'K';
      return '$' + n.toFixed(0);
    }

    function draw() {
      setupCanvas();
      const rect = canvas.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      const padding = 50;

      const initialPrice = parseFloat(initialPriceSlider.value);
      const currentPrice = parseFloat(currentPriceSlider.value);

      // Initial position: 1 ETH + equivalent USD
      const initialEth = 1;
      const initialUsd = initialPrice; // 50/50 split means USD equals 1 ETH worth
      const initialTotal = initialEth * initialPrice + initialUsd;

      const priceRatio = currentPrice / initialPrice;
      const il = calculateIL(priceRatio);

      const hodl = calculateHodlValue(initialEth, initialUsd, currentPrice);
      const lp = calculateLPValue(initialEth, initialUsd, initialPrice, currentPrice);

      // Update UI
      document.getElementById('initialPriceDisplay').textContent = initialPrice.toLocaleString();
      document.getElementById('currentPriceDisplay').textContent = currentPrice.toLocaleString();
      document.getElementById('initialUsd').textContent = '$' + initialPrice.toLocaleString();

      const priceChangePercent = ((currentPrice - initialPrice) / initialPrice * 100);
      document.getElementById('priceChange').textContent =
        (priceChangePercent >= 0 ? '+' : '') + priceChangePercent.toFixed(0) + '% change';

      document.getElementById('hodlValue').textContent = formatCurrency(hodl.total);
      document.getElementById('hodlDetail').textContent =
        `${hodl.eth.toFixed(2)} ETH + $${hodl.usd.toFixed(0)}`;

      document.getElementById('lpValue').textContent = formatCurrency(lp.total);
      document.getElementById('lpDetail').textContent =
        `${lp.eth.toFixed(2)} ETH + $${lp.usd.toFixed(0)}`;

      const ilPercent = Math.abs(il * 100);
      const ilValueEl = document.getElementById('ilValue');
      ilValueEl.textContent = ilPercent.toFixed(2) + '%';
      ilValueEl.classList.toggle('zero', ilPercent < 0.01);

      const ilNoteEl = document.getElementById('ilNote');
      if (ilPercent < 0.01) {
        ilNoteEl.textContent = 'No loss when price unchanged';
      } else {
        const lossAmount = hodl.total - lp.total;
        ilNoteEl.textContent = `You'd have $${lossAmount.toFixed(0)} more if you just held`;
      }

      // Clear canvas
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fillRect(0, 0, width, height);

      // Calculate ranges for chart
      const minPrice = 100;
      const maxPrice = 5000;

      // Find max values for y-axis
      let maxValue = 0;
      let maxIL = 0;
      for (let p = minPrice; p <= maxPrice; p += 50) {
        const h = calculateHodlValue(initialEth, initialUsd, p);
        const l = calculateLPValue(initialEth, initialUsd, initialPrice, p);
        maxValue = Math.max(maxValue, h.total, l.total);
        maxIL = Math.max(maxIL, Math.abs(calculateIL(p / initialPrice)));
      }
      maxValue *= 1.1;

      // Draw grid
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (height - 2 * padding) * (1 - i / 5);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();

        const x = padding + (width - 2 * padding) * i / 5;
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, height - padding);
        ctx.stroke();
      }

      // Helper to convert price to x
      const priceToX = (p) => padding + (width - 2 * padding) * ((p - minPrice) / (maxPrice - minPrice));
      const valueToY = (v) => height - padding - (height - 2 * padding) * (v / maxValue);

      // Draw HODL line
      ctx.beginPath();
      ctx.strokeStyle = '#00d9ff';
      ctx.lineWidth = 3;
      for (let p = minPrice; p <= maxPrice; p += 20) {
        const h = calculateHodlValue(initialEth, initialUsd, p);
        const x = priceToX(p);
        const y = valueToY(h.total);
        if (p === minPrice) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // Draw LP line
      ctx.beginPath();
      ctx.strokeStyle = '#ff9f43';
      ctx.lineWidth = 3;
      for (let p = minPrice; p <= maxPrice; p += 20) {
        const l = calculateLPValue(initialEth, initialUsd, initialPrice, p);
        const x = priceToX(p);
        const y = valueToY(l.total);
        if (p === minPrice) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // Fill the gap between HODL and LP (IL area)
      ctx.beginPath();
      ctx.fillStyle = 'rgba(255, 107, 107, 0.2)';
      for (let p = minPrice; p <= maxPrice; p += 20) {
        const h = calculateHodlValue(initialEth, initialUsd, p);
        const x = priceToX(p);
        const y = valueToY(h.total);
        if (p === minPrice) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      for (let p = maxPrice; p >= minPrice; p -= 20) {
        const l = calculateLPValue(initialEth, initialUsd, initialPrice, p);
        const x = priceToX(p);
        const y = valueToY(l.total);
        ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.fill();

      // Draw current price line
      ctx.beginPath();
      ctx.strokeStyle = '#51cf66';
      ctx.lineWidth = 2;
      ctx.setLineDash([6, 6]);
      const currentX = priceToX(currentPrice);
      ctx.moveTo(currentX, padding);
      ctx.lineTo(currentX, height - padding);
      ctx.stroke();
      ctx.setLineDash([]);

      // Draw current position dots
      const hodlY = valueToY(hodl.total);
      const lpY = valueToY(lp.total);

      ctx.beginPath();
      ctx.arc(currentX, hodlY, 8, 0, Math.PI * 2);
      ctx.fillStyle = '#00d9ff';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(currentX, lpY, 8, 0, Math.PI * 2);
      ctx.fillStyle = '#ff9f43';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Axis labels
      ctx.fillStyle = '#666';
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'center';
      for (let i = 0; i <= 5; i++) {
        const price = minPrice + (maxPrice - minPrice) * i / 5;
        const x = priceToX(price);
        ctx.fillText('$' + price.toFixed(0), x, height - padding + 20);

        const val = maxValue * i / 5;
        const y = height - padding - (height - 2 * padding) * i / 5;
        ctx.textAlign = 'right';
        ctx.fillText(formatCurrency(val), padding - 10, y + 4);
        ctx.textAlign = 'center';
      }

      // Axis titles
      ctx.fillStyle = '#888';
      ctx.font = '14px sans-serif';
      ctx.fillText('ETH Price', width / 2, height - 10);
      ctx.save();
      ctx.translate(15, height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('Portfolio Value', 0, 0);
      ctx.restore();

      // Mark initial price
      const initialX = priceToX(initialPrice);
      ctx.fillStyle = '#666';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('▲', initialX, height - padding + 35);
      ctx.fillText('entry', initialX, height - padding + 47);
    }

    // Event listeners
    initialPriceSlider.addEventListener('input', draw);
    currentPriceSlider.addEventListener('input', draw);
    window.addEventListener('resize', draw);

    // Initial draw
    draw();
  </script>
</body>
</html>
